#!/bin/bash

if [ -z "$1" ]; then
cat <<EOU
Compute CBF maps from pCASL images using the formulas from Alsop et al. (2015).

Usage: alsop -i pcasl_4d -c aslcontext.tsv -b M0_pe_reversed -o outdir

-i : Input 4D file. First volume is M0, followed by pairs label then control.
-c : BIDS ASL context file, with columns for LD and PLD.
-b : Phase-encoding reversed acquisition. First volume is M0, the others are ignored.
-o : Output directory.

EPI Factor and Echo Spacing are hard coded inside the script.
Phase encoding direction is assumed along the +y/-y direction. To change to x or z, edit inside.
_____________________________________
Anderson M. Winkler
The University of Texas Rio Grande Valley
Apr/2025
http://brainder.org
EOU
exit 1
fi

while getopts ":i:o:c:b:" OPTIONS; do
  case ${OPTIONS} in
    i) ASLIN=${OPTARG} ;;
    o) OUTDIR=${OPTARG} ;;
    c) CONTEXT=${OPTARG} ;;
    b) BLIP=${OPTARG} ;;
    \?) echo "Invalid option: -${OPTARG}"; exit 1;;
    :) echo "Option -${OPTARG} requires an argument"; exit 1;;
  esac
done

# Parameters from our sequence
EPIFactor=37
EchoSpacing=0.54 # in ms

# Arrays with labeling durations and post-labeling delays
LD=($( awk 'NR>1 {printf "%s ", $2}' ${CONTEXT}))
PLD=($(awk 'NR>1 {printf "%s ", $3}' ${CONTEXT}))

# Constants from the Alsop et al (2015) paper
lambda=0.9
T1blood=1650
alpha=0.85

TMPDIR=${OUTDIR}/temp_$(printf "%04x" ${RANDOM})
mkdir -p ${TMPDIR}
#: <<EOX
# Break M0 from the pairs label/control
echo "Reorganizing M0 and label-control pairs"
${FSLDIR}/bin/fslroi ${BLIP}  ${TMPDIR}/m0_blip 0 1
${FSLDIR}/bin/fslroi ${ASLIN} ${TMPDIR}/m0 0 1
${FSLDIR}/bin/fslroi ${ASLIN} ${TMPDIR}/lc 1 -1
${FSLDIR}/bin/fslmerge -t ${TMPDIR}/m0_both ${TMPDIR}/m0 ${TMPDIR}/m0_blip

# Topup
echo "Running topup"
DwellTime=$(dc -e "10 k ${EPIFactor} ${EchoSpacing} * 1000 / p")
cat <<EOF > ${TMPDIR}/topup_params.txt
0 1 0 ${DwellTime}
0 -1 0 ${DwellTime}
EOF
${FSLDIR}/bin/topup --imain=${TMPDIR}/m0_both \
                    --datain=${TMPDIR}/topup_params.txt \
                    --config=b02b0.cnf \
                    --out=${TMPDIR}/topup
${FSLDIR}/bin/applytopup --imain=${TMPDIR}/m0,${TMPDIR}/m0_blip \
                         --inindex=1,2 \
                         --datain=${TMPDIR}/topup_params.txt \
                         --topup=${TMPDIR}/topup \
                         --method=jac \
                         --out=${TMPDIR}/m0_topup
${FSLDIR}/bin/applytopup --imain=${TMPDIR}/lc \
                         --inindex=1 \
                         --datain=${TMPDIR}/topup_params.txt \
                         --topup=${TMPDIR}/topup \
                         --method=jac \
                         --out=${TMPDIR}/lc_topup

echo "Splitting label-control timeseries into individual volumes"
${FSLDIR}/bin/fslsplit ${TMPDIR}/lc_topup ${TMPDIR}/vol_ -t
#EOX

echo "Computing perfusion maps"
nvols=$(${FSLDIR}/bin/fslnvols ${TMPDIR}/lc)
npairs=$(dc -e "${nvols} 2 / p")
echo $nvols $npairs
i=0
CBFLIST=""
for ((p=0;p<${npairs};p++)) ; do
   echo "Working on LD=${LD[p]} PLD=${PLD[p]}"
   lab=$(printf "%04d" ${i})
   con=$(printf "%04d" $((i+1)))
   pair=$(printf "%04d" $((p+1)))
   ctenum=$(echo "scale=10; e(${PLD[p]}/${T1blood}) * ${lambda} * 6000" | bc -l)
   cteden=$(echo "scale=10; (1 - e(-${LD[p]}/${T1blood})) * ${alpha} * 2" | bc -l)
   ${FSLDIR}/bin/fslmaths ${TMPDIR}/vol_${con} -sub ${TMPDIR}/vol_${lab} -div ${TMPDIR}/m0_topup -mul ${ctenum} -div ${cteden} ${TMPDIR}/cbf_${pair}
   CBFLIST="${CBFLIST} ${TMPDIR}/cbf_${pair}"
   i=$((i+2))
done

echo "Merging results"
${FSLDIR}/bin/fslmerge -t ${OUTDIR}/alsop ${CBFLIST}

echo "Removing temporary files"
rm -rf ${TMPDIR}
echo "Done"
